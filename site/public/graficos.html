<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <title>Gráficos</title>
    <link rel="stylesheet" href="./css/dashboardStyle.css" />
    <link rel="stylesheet" href="./css/graficos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <script
    data-jsd-embedded
    data-key="4585f893-7c1b-400e-baab-8f890fc4a01e"
    data-base-url="https://jsd-widget.atlassian.com"
    src="https://jsd-widget.atlassian.com/assets/embed.js"
  ></script>
  <body>
    <!-- ------------------------------------------------------------------ HEADER --------------------------------------------------------------- -->
    <div class="header">
      <div class="logo">
        <a href="dashboardIndex.html"><h1>SaveBlood</h1></a>
      </div>
    </div>
    <!-- ------------------------------------------------------------- FIM DA HEADER ---------------------------------------------------- ------- -->

    <div class="tudo">
      <!-- tudo ksksk -->
      <!-- ------------------------------------------------------   div da esquerda ----------------------------------------------------------- -->

      <div class="navegacao_lateral">
        <div class="navegacao_lateral_dropdown">
          <label>
            <img src="assets/geladeira-removebg-preview.png" />
            <a href="gráficosDinamico.html">Estoque</a>
          </label>

          <label>
            <img src="assets/alerta-removebg-preview.png" />
            <a href="#">Registros</a>
          </label>
        </div>
      </div>

      <!-- ------------------------------------------------------ fim div da esquerda ---------------------------------------------------------- -->

      <!-- ------------------------------------------------------------- sensores ---------------------------------------------------------------- -->

      <div class="espaço_sensores" id="espaco_sensores">
        <!-- sensor 1 -->
        <!-- <div id="sensorDiv1" class="container_sensor">
          <div class="metadeCima" style="margin-top: -20xp">
            <div class="sensor">
              <img src="images/lm35.png" width="100%" />
            </div>

            <div class="dadosSensores">
              <a href="sensor.html">
                <span class="identificação corAlt"> Sensor #1012</span>
              </a>
              <span class="geladeira corAlt2"> Geladeira: 012</span>
              <div class="status">
                <span>status:</span> <span id="joinha">&#128077;</span>
              </div>
            </div>
          </div>

          <div class="metadeBaixo">
            <div class="grafico_linha" style="height: 100%; width: 70%">
              <canvas id="myChart1"></canvas>
            </div>

            <p class="container_sensor_input" id="temperaturaValor1"></p>
          </div>
        </div> -->

        <div
          class="sensorContainer"
          id="sensorDiv1"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <div>
              <span class="identificação corAlt"> Sensor #1012</span>
            </div>
            <span class="geladeira corAlt2"> Geladeira: 012</span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span
              class="valorTemperatura"
              style="font-size: 30px"
              id="temperaturaValor1"
            ></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart1"></canvas>
          </div>
        </div>

        <div
          class="sensorContainer"
          id="sensorDiv2"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <a href="sensor.html">
              <span class="identificação corAlt"> Sensor #1012</span>
            </a>
            <span class="geladeira corAlt2"> Geladeira: 012</span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span style="font-size: 30px" id="temperaturaValor2"></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart2"></canvas>
          </div>
        </div>

        <div
          class="sensorContainer"
          id="sensorDiv3"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <a href="sensor.html">
              <span class="identificação corAlt"> Sensor #1012</span>
            </a>
            <span class="geladeira corAlt2"> Geladeira: 012</span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span style="font-size: 30px" id="temperaturaValor3"></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart3"></canvas>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  function obterDadosGrafico() {
    alterarTitulo(idAquario);

    if (proximaAtualizacao != undefined) {
      clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/${idAquario}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
            resposta.reverse();

            plotarGrafico(resposta, idAquario);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
  // Configura o gráfico (cores, tipo, etc), materializa-o na página e,
  // A função *plotarGrafico* também invoca a função *atualizarGrafico*
  function plotarGrafico(resposta, idAquario) {
    console.log("iniciando plotagem do gráfico...");

    // Criando estrutura para plotar gráfico - labels
    let labels = [];

    // Criando estrutura para plotar gráfico - dados
    let dados = {
      labels: labels,
      datasets: [
        {
          label: "Temperatura",
          data: [],
          fill: false,
          borderColor: "rgb(199, 52, 52)",
          tension: 0.1,
        },
      ],
    };

    console.log("----------------------------------------------");
    console.log(
      'Estes dados foram recebidos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":'
    );
    console.log(resposta);

    // Inserindo valores recebidos em estrutura para plotar o gráfico
    for (i = 0; i < resposta.length; i++) {
      var registro = resposta[i];
      labels.push(registro.momento_grafico);
      dados.datasets[0].data.push(registro.lm35_temperatura);
    }

    console.log("----------------------------------------------");
    console.log("O gráfico será plotado com os respectivos valores:");
    console.log("Labels:");
    console.log(labels);
    console.log("Dados:");
    console.log(dados.datasets);
    console.log("----------------------------------------------");

    // Criando estrutura para plotar gráfico - config
    const config = {
      type: "line",
      data: dados,
      options: {
        scales: {
          y: {
            min: 0,
            max: 10,
          },
        },
      },
    };

    // Adicionando gráfico criado em div na tela
    let myChart = new Chart(
      document.getElementById(`myChartCanvas${idAquario}`),
      config
    );

    setTimeout(() => atualizarGrafico(idAquario, dados, myChart), 2000);
  }

  // Esta função *atualizarGrafico* atualiza o gráfico que foi renderizado na página,
  // buscando a última medida inserida em tabela contendo as capturas,

  //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
  //     Para ajustar o "select", ajuste o comando sql em src/models
  function atualizarGrafico(idAquario, dados, myChart) {
    fetch(`/medidas/tempo-real/${idAquario}`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (novoRegistro) {
            obterdados(idAquario);
            // alertar(novoRegistro, idAquario);
            console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
            console.log(`Dados atuais do gráfico:`);
            console.log(dados);

            let avisoCaptura = document.getElementById(
              `avisoCaptura${idAquario}`
            );
            avisoCaptura.innerHTML = "";

            if (
              novoRegistro[0].momento_grafico ==
              dados.labels[dados.labels.length - 1]
            ) {
              console.log(
                "---------------------------------------------------------------"
              );
              console.log(
                "Como não há dados novos para captura, o gráfico não atualizará."
              );
              avisoCaptura.innerHTML =
                "<i class='fa-solid fa-triangle-exclamation'></i> Foi trazido o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará.";
              console.log("Horário do novo dado capturado:");
              console.log(novoRegistro[0].momento_grafico);
              console.log("Horário do último dado capturado:");
              console.log(dados.labels[dados.labels.length - 1]);
              console.log(
                "---------------------------------------------------------------"
              );
            } else {
              // tirando e colocando valores no gráfico
              dados.labels.shift(); // apagar o primeiro
              dados.labels.push(novoRegistro[0].momento_grafico); // incluir um novo momento

              dados.datasets[0].data.shift(); // apagar o primeiro de temperatura
              dados.datasets[0].data.push(novoRegistro[0].lm35_temperatura); // incluir uma nova medida de temperatura

              myChart.update();
            }

            // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
            proximaAtualizacao = setTimeout(
              () => atualizarGrafico(idAquario, dados, myChart),
              2000
            );
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API legal legal");
          // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápido ou mais devagar
          proximaAtualizacao = setTimeout(
            () => atualizarGrafico(idAquario, dados, myChart),
            2000
          );
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }

  const ctx = document.getElementById("myChart1");
  var grafico1 = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  const ctx2 = document.getElementById("myChart2");
  var grafico2 = new Chart(ctx2, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  const ctx3 = document.getElementById("myChart3");
  var grafico3 = new Chart(ctx3, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var listaGraficos = [grafico1, grafico2, grafico3];
  setInterval(() => {
    fetch("/medidas/lm35", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    }).then((response) => {
      response.json().then((json) => {
        // console.log(json);
        var resposta = json;
        console.log(json);

        var listaSensores = [];
        listaSensores.push(json[0].temperatura);
        listaSensores.push(json[1].temperatura);
        listaSensores.push(json[2].temperatura);
        console.log(listaSensores);

        for (
          var incremento = 0;
          incremento < listaSensores.length;
          incremento++
        ) {
          var text = document.getElementById(
            `temperaturaValor${incremento + 1}`
          );

          text.innerHTML = `${listaSensores[incremento]}ºC`;

          var element = document.getElementById(`sensorDiv${incremento + 1}`);

          if (listaSensores[incremento] < 2 || listaSensores[incremento] > 6) {
            element.style.border = "3px solid red";
          } else if (
            listaSensores[incremento] < 2.5 ||
            listaSensores[incremento] > 5.5
          ) {
            element.style.border = "3px solid yellow";
          } else {
            element.style.border = "none";
          }
          atualizarGrafico(
            listaGraficos[incremento],
            listaSensores[incremento]
          );
        }
      });
    });
  }, 1000);

  function atualizarGrafico(grafico, dado) {
    if (grafico.data.datasets[0].data.length == 10) {
      grafico.data.datasets[0].data.shift();
      grafico.data.labels.shift();
    }
    grafico.data.datasets[0].data.push(dado);
    grafico.data.labels.push(dado);
    grafico.update();
  }

  function escolherSensor(id) {
    console.log(id);

    if (id == "sensorDiv1") {
      sessionStorage.SENSOR = 1001;
    } else if (id == "sensorDiv2") {
      sessionStorage.SENSOR = 1002;
    } else {
      sessionStorage.SENSOR = 1004;
    }

    window.location.href = "sensor.html";
  }

  setInterval(() => {
    fetch(`/medidas/alertas/`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(resposta[0].tipo, resposta[0].fkSensor);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }

    })
        .catch(function (error) {
            console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
        });
}, 500);
</script>

<!-- <script>
  function funcao() {
    var sensor = document.querySelector(".container_sensor");
    var temp = document.getElementById("temperaturaValor");
    var cor = document.querySelector(".corAlt");
    var cor2 = document.querySelector(".corAlt2");
    var corInput = document.querySelector(".container_sensor_input");
    var status = document.querySelector(".status");
    var joia = document.getElementById("joinha");

    if (temp.value >= 6 || temp.value <= 2) {
      sensor.style.backgroundColor = "#ff0022";
      sensor.style.borderColor = "#3b1111";
      cor.style.backgroundColor = "#3b1111";
      cor2.style.backgroundColor = "#3b1111";
      corInput.style.backgroundColor = "#ff0022";
      status.style.backgroundColor = "#ff0022";
      status.style.color = "#3b1111";
      joia.innerHTML = "&#9888;";
    } else if (temp.value >= 5.5 || temp.value <= 2.5) {
      sensor.style.backgroundColor = "#ffc342";
      sensor.style.borderColor = "#ee8742";
      cor.style.backgroundColor = "#86523b";
      cor2.style.backgroundColor = "#86523b";
      corInput.style.backgroundColor = "#ffc342";
      status.style.backgroundColor = "#ffc342";
      joia.innerHTML = "&#10071;";
    } else {
      sensor.style.backgroundColor = "rgb(189, 201, 212);";
    }
  }
</script> -->
