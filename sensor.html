<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <title>Gráficos</title>
    <link rel="stylesheet" href="dashboardStyle.css" />
    <link rel="stylesheet" href="graficos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <!-- ------------------------------------------------------------------ HEADER --------------------------------------------------------------- -->
    <div class="header">
      <div class="logo">
        <a href="dashboardIndex.html"><h1>SaveBlood</h1></a>
      </div>
    </div>
    <!-- ------------------------------------------------------------- FIM DA HEADER ---------------------------------------------------- ------- -->

    <div class="tudo">
      <!-- tudo ksksk -->
      <!-- ------------------------------------------------------   div da esquerda ----------------------------------------------------------- -->

      <div class="parteEsquerda">
        <div class="lista">
          <span>ESTOQUES</span>

          <div class="estoque"><a href="gráficos.html">Estoque Norte</a></div>
          <div class="estoque"><a href="gráficos.html">Estoque Leste</a></div>
          <div class="estoque"><a href="gráficos.html">Estoque Sul</a></div>
          <div class="estoque"><a href="gráficos.html">Estoque Oeste</a></div>
        </div>
      </div>

      <!-- ------------------------------------------------------ fim div da esquerda ---------------------------------------------------------- -->
      <div class="sensor_isolado">
        <div class="solitude" id="graficoTemp">
          <canvas id="lm35Temperatura"></canvas>
        </div>

        <div class="dadosSolitude">
          <div class="dadosQuestão">
            <div class="data">
              <span>data</span>
              <input type="date" id="diaValor" />
            </div>

            <div class="hora">
              <span>hora</span>
              <input type="time" />
            </div>
          </div>

          <div class="dadosResposta"></div>
        </div>
      </div>

      <script>
        var contextoLm35Temperatura = document
          .getElementById("lm35Temperatura")
          .getContext("2d");
        var lm35Temperatura = new Chart(contextoLm35Temperatura, {
          type: "line",
          data: {
            datasets: [
              {
                label: "Temperatura",
                type: "line",
                borderColor: ["#ffd902"],
                backgroundColor: ["#ffe135"],
                tension: 0.2,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
                max: 7,
              },
              xAxes: [
                {
                  distribution: "series",
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
              yAxes: [
                {
                  scaleLabel: {
                    display: true,
                    labelString: "Temperatura",
                  },
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
            animation: {
              duration: 0,
            },
          },
        });

        var paginacao = {};
        var tempo = {};
        function obterDados(grafico, endpoint) {
          var http = new XMLHttpRequest();
          http.open("GET", "http://localhost:3300/sensores/" + endpoint, false);
          http.send(null);
          var valores = JSON.parse(http.responseText);
          if (paginacao[endpoint] == null) {
            paginacao[endpoint] = 0;
          }
          if (tempo[endpoint] == null) {
            tempo[endpoint] = 0;
          }
          // Exibir à partir do último elemento exibido anteriormente
          var ultimaPaginacao = paginacao[endpoint];
          paginacao[endpoint] = valores.length;
          var valores = valores.slice(ultimaPaginacao);
          valores.forEach((valor) => {
            //Máximo de 60 itens exibidos no gráfico
            if (
              grafico.data.labels.length == 10 &&
              grafico.data.datasets[0].data.length == 10
            ) {
              grafico.data.labels.shift();
              grafico.data.datasets[0].data.shift();
            }

            grafico.data.labels.push(tempo[endpoint]++);
            grafico.data.datasets[0].data.push(parseFloat(valor));
            grafico.update();
          });
        }

        setInterval(() => {
          obterDados(lm35Temperatura, "lm35/temperatura");
        }, 500);
      </script>
    </div>
  </body>
</html>
