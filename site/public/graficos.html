<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap"
      rel="stylesheet"
    />
    <title>Gráficos</title>
    <link rel="stylesheet" href="./css/dashboardStyle.css" />
    <link rel="stylesheet" href="./css/graficos.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>

  <script
    data-jsd-embedded
    data-key="4585f893-7c1b-400e-baab-8f890fc4a01e"
    data-base-url="https://jsd-widget.atlassian.com"
    src="https://jsd-widget.atlassian.com/assets/embed.js"
  ></script>
  <body>
    <!-- ------------------------------------------------------------------ HEADER --------------------------------------------------------------- -->
    <div class="header">
      <div class="logo">
        <a href="dashboardIndex.html"><h1>SaveBlood</h1></a>
      </div>
    </div>
    <!-- ------------------------------------------------------------- FIM DA HEADER ---------------------------------------------------- ------- -->

    <div class="tudo">
      <!-- tudo ksksk -->
      <!-- ------------------------------------------------------   div da esquerda ----------------------------------------------------------- -->

      <div class="navegacao_lateral">
        <div class="navegacao_lateral_dropdown">
          <label>
            <img src="assets/geladeira-removebg-preview.png" />
            <a href="gráficosDinamico.html">Estoque</a>
          </label>

          <label>
            <img src="assets/alerta-removebg-preview.png" />
            <a href="#">Registros</a>
          </label>
        </div>
      </div>

      <!-- ------------------------------------------------------ fim div da esquerda ---------------------------------------------------------- -->

      <!-- ------------------------------------------------------------- sensores ---------------------------------------------------------------- -->

      <div class="espaço_sensores" id="espaco_sensores">
        <!-- sensor 1 -->
        <!-- <div id="sensorDiv1" class="container_sensor">
          <div class="metadeCima" style="margin-top: -20xp">
            <div class="sensor">
              <img src="images/lm35.png" width="100%" />
            </div>

            <div class="dadosSensores">
              <a href="sensor.html">
                <span class="identificação corAlt"> Sensor #1012</span>
              </a>
              <span class="geladeira corAlt2"> Geladeira: 012</span>
              <div class="status">
                <span>status:</span> <span id="joinha">&#128077;</span>
              </div>
            </div>
          </div>

          <div class="metadeBaixo">
            <div class="grafico_linha" style="height: 100%; width: 70%">
              <canvas id="myChart1"></canvas>
            </div>

            <p class="container_sensor_input" id="temperaturaValor1"></p>
          </div>
        </div> -->

        <div
          class="sensorContainer"
          id="sensorDiv1"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <div>
              <span class="identificação corAlt">
                Sensor #<span id="idSensor1"></span
              ></span>
            </div>
            <span class="geladeira corAlt2" id="geladeira1"></span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span
              class="valorTemperatura"
              style="font-size: 30px"
              id="temperaturaValor1"
            ></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart1"></canvas>
          </div>
        </div>

        <div
          class="sensorContainer"
          id="sensorDiv2"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <a href="sensor.html">
              <span class="identificação corAlt">
                Sensor #<span id="idSensor2"></span
              ></span>
            </a>
            <span class="geladeira corAlt2" id="geladeira2"></span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span style="font-size: 30px" id="temperaturaValor2"></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart2"></canvas>
          </div>
        </div>

        <div
          class="sensorContainer"
          id="sensorDiv3"
          onclick="escolherSensor(this.id)"
        >
          <div class="dadosSensores">
            <a href="sensor.html">
              <span class="identificação corAlt">
                Sensor #<span id="idSensor3"></span
              ></span>
            </a>
            <span class="geladeira corAlt2" id="geladeira3"></span>
            <div class="status">
              <span>status:</span> <span id="joinha">&#128077;</span>
            </div>
            <span style="font-size: 30px" id="temperaturaValor3"></span>
          </div>
          <div class="graficoContainer">
            <canvas id="myChart3"></canvas>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  const ctx = document.getElementById("myChart1");
  var grafico1 = new Chart(ctx, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  const ctx2 = document.getElementById("myChart2");
  var grafico2 = new Chart(ctx2, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  const ctx3 = document.getElementById("myChart3");
  var grafico3 = new Chart(ctx3, {
    type: "line",
    data: {
      datasets: [
        {
          label: "temp",
          borderColor: "rgba(255, 99, 131, 1)",
          backgroundColor: "rgba(255, 99, 131, 1)",
          borderWidth: 2,
        },
      ],
    },
    options: {
      scales: {
        y: {
          beginAtZero: true,
        },
      },
    },
  });

  var listaGraficos = [grafico1, grafico2, grafico3];
  var listaDados = [grafico1, grafico2, grafico3];
  setInterval(() => {
    fetch("/medidas/lm35", {
      method: "GET",
      headers: {
        "Content-Type": "application/json",
      },
    }).then((response) => {
      response.json().then((json) => {
        // console.log(json);
        var resposta = json;
        console.log(json);

        var listaSensores = [];
        listaSensores.push(json[0].temperatura);
        listaSensores.push(json[1].temperatura);
        listaSensores.push(json[2].temperatura);
        console.log(listaSensores);

        for (
          var incremento = 0;
          incremento < listaSensores.length;
          incremento++
        ) {
          var valorTemperatura = document.getElementById(
            `temperaturaValor${incremento + 1}`
          );

          var idSensor = document.getElementById(`idSensor${incremento + 1}`);

          var idGeladeira = document.getElementById(
            `geladeira${incremento + 1}`
          );

          idSensor.innerHTML = json[incremento].idSensor;
          idGeladeira.innerHTML = json[incremento].geladeira;
          document
            .getElementById(`sensorDiv${incremento + 1}`)
            .setAttribute(
              "onclick",
              `escolherSensor(${json[incremento].idSensor})`
            );

          valorTemperatura.innerHTML = `${listaSensores[incremento]}ºC`;

          var element = document.getElementById(`sensorDiv${incremento + 1}`);

          if (listaSensores[incremento] < 2 || listaSensores[incremento] > 6) {
            element.style.border = "3px solid red";
          } else if (
            listaSensores[incremento] < 2.5 ||
            listaSensores[incremento] > 5.5
          ) {
            element.style.border = "3px solid yellow";
          } else {
            element.style.border = "none";
          }
          atualizarGrafico(
            listaGraficos[incremento],
            listaSensores[incremento]
          );
        }
      });
    });
  }, 1000);

  function atualizarGrafico(grafico, dado) {
    if (grafico.data.datasets[0].data.length == 10) {
      grafico.data.datasets[0].data.shift();
      grafico.data.labels.shift();
    }
    grafico.data.datasets[0].data.push(dado);
    grafico.data.labels.push(dado);
    grafico.update();
  }

  function escolherSensor(id) {
    console.log(id);

    sessionStorage.SENSOR = id;

    window.location.href = "sensor.html";
  }

  setInterval(() => {
    fetch(`/medidas/alertas/`, { cache: "no-store" })
      .then(function (response) {
        if (response.ok) {
          response.json().then(function (resposta) {
            console.log(resposta[0].tipo, resposta[0].fkSensor);
          });
        } else {
          console.error("Nenhum dado encontrado ou erro na API");
        }
      })
      .catch(function (error) {
        console.error(
          `Erro na obtenção dos dados p/ gráfico: ${error.message}`
        );
      });
  }, 500);
</script>
