<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap"
    rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,300;0,400;0,500;0,700;1,400&display=swap"
    rel="stylesheet" />
  <title>dashboards</title>
  <link rel="stylesheet" href="css/dashboardStyle.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body onload="validarSessao(), listarFuncionarios(), pegarMediaAlertas()">

  <main>

    <!-- COISINHA DO LADO -->
    <div class="navegacao_lateral">
        
      <div class="navegacao_lateral_dropdown">  

          <label>
              <a href="graficos.html"><img src="assets/geladeira-removebg-preview.png"></a> 
              <a href="gráficosDinamico.html">Estoque</a>
          </label> 

          <label>
              <img src="assets/alerta-removebg-preview.png">
              <a href="#">Registros</a>
          </label>

      </div>
      
    </div>
    <!-- FIM DA COISINHA DO LADO -->


    <!-- VISÃO GERAL -->
    <div class="geral">

      <!-- nome + barra de pesquisa -->

      <div class="BemVindo">
        <div>
          <span>Bem vindo(a), <span id="nome_do_usuario"></span></span>
        </div>

        <div style="display: flex; justify-content: space-evenly;width: 650px; align-items: center;">
          <input id="input_pesquisa" placeholder="Pesquisar">
          <a href="cadastro-funcionario.html" class="buttonCadastrar">Cadastrar funcionário</a>
          <span id="nomeUsuario_denovo"></span>
          <img src="assets/sair.png" alt="Log-out" onclick="sair()" style="cursor: pointer;">
          
        </div>
      </div>

      <div class="dashboards">

        <!-- cards -->
        <div class="graphics"> <!-- container com tudo debaixo da barra de cima -->



          <div class="status"> <!-- div utilizada para manter os cards e o gráfico de barras na mesma coluna -->

            <div class="container"> <!-- container contendo os cards -->


              <!-- card1 -->
              <div class="card">
                <div style="margin: 5px;">
                  <span>Quantidade de geladeiras</span>
                  <div style="display: flex; margin-top: 10px;">
                    <div class="barra azul"></div>
                    <b>2532</b>
                  </div>
                </div>
              </div>

              <!-- card2 -->
              <div class="card">
                <div style="margin: 5px;">
                  <span>Status</span>
                  <div style="display: flex; margin-top: 10px;">
                    <div class="barra verde"></div>
                    <b>Tudo ok!</b>
                  </div>
                </div>
              </div>
            </div>


            <!-- gráfico ----------- ATUALIZAR DADOS DO GRÁFICO (antes era qntd, agora v ai ser média)-->
            <div class="grafico">
              <span>MÉDIA DE ALERTAS POR MÊS</span>
              <canvas id="myChart"></canvas>
            </div>
          </div>

          <div class="rolha"> <!--div para o gráfico de rolhas + dados adicionais-->

            <div style="display: flex; flex-direction: column; align-items: center;">
              <div class="perdidos">
                <span>AQUI VAI FICAR OS SENSORES EM ALERTA <br>POVO BONITO</span>
              </div>


              <!-- grafico de rolha -->
              <div class="graficoRolha">
                <canvas id="myChart2"></canvas>
              </div>

            </div>

            <div class="informações">
              <span>Total de litros armazenado: <br>
                Total de litros Perdidos:
              </span>

              <span>1500L<br>
                150
                L</span>
            </div>


          </div>




        </div> <!--fim da div "dashboards" -->
        <div class="">
          <canva id="moneyChart"></canva>
        </div>


        <!-- FIM DA VISÃO GERAL -->
        <div class="container">
          <div id="funcionarioCadastrado"
            style="
            background-color: white; 
            width: 990px; height: 200px; 
            justify-content: center; text-align: center; 
            margin-left: 150px; margin-top: 50px; border-radius: 10px; padding: 15px; ">
            <!-- <p>Funionários cadastrados</p> -->

            <div>


              <!-- aqui é um template dos funcionários, os de verdade são inseridos através de um select no banco, que insere funcoinario por funcionario
                
              <div>
                  <span id="nomeFuncionario">nome do funcionaro: jorge</span>
                  <span id="emailFuncionario">email: @gmail.com</span>
                  <span id="telefoneFuncionario">número: 120985</span>
              </div> -->
                

              <!-- Testando o formato tabela -->
              <table border="1"  id="funcionarios">
                <caption><strong>Funionários cadastrados</strong></caption> <!-- title-->

            </table>
              

              

            </div>
          </div>

        </div>
      </div>
    </div>
</body>

</html>

<script>


  const ctx2 = document.getElementById('myChart2');

  new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: ['Total', 'Perdidos'],
      datasets: [{
        label: 'litros de sangue',
        backgroundColor: [
          'rgba(67, 209, 67, 1)',
          'rgba(255, 99, 131, 1)'
        ],
        data: [1500, 150],
        borderWidth: 0,
      },
      ]

    },
    hoverOffset: 4
  });

  const moneyCtx = document.getElementById('moneyChart');

  new Chart(moneyCtx, {
    type: 'line',
    data: {
      labels: ['Total'],
      datasets: [{
        label: 'litros de sangue',
        backgroundColor: [
          'rgba(67, 209, 67, 1)',
          'rgba(255, 99, 131, 1)'
        ],
        data: [1500, 150],
        borderWidth: 0,
      },
      ]

    },
    hoverOffset: 4
  });

  /*
  function viewExit() {
    viewDivExit = !viewDivExit
    if (viewDivExit) {
      profile.innerHTML = '<div class="foto"></div>'
    } else {
      profile.innerHTML = '<div class="foto"></div><div class="exit"><a href="page_login.html">Sair</a></div>'
    }

  }
  */


  function validarSessao() {

    var gestor = sessionStorage.GESTOR
    var usuario = sessionStorage.NOME_USUARIO

    nome_do_usuario.innerHTML = usuario
    nomeUsuario_denovo.innerHTML = usuario
  }

  function listarFuncionarios() {
      var gestor = sessionStorage.ID_USUARIO;

      fetch(`/usuarios/listar/${gestor}`,  { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {

                    console.log('pericias encontradas:' + resposta.length)
    
                  plotarFuncionarios(resposta)

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
  }

  function plotarFuncionarios(resposta) {


    for (i = 0; i < resposta.length; i ++) {

      console.log(resposta)

      funcionarios.innerHTML += `
               <tr> <!-- header-->
                    <th>${resposta[i].nomeNick}</th>
                    <th>${resposta[i].email}</th>
                    <th>${resposta[i].telefone}</th>
                </tr>
            `;

    }



  }

  function sair() {

    sessionStorage.clear()
    window.location = "page_login.html"

  }



  function pegarMediaAlertas() {


fetch(`/medidas/mediaAlerta/`, { cache: 'no-store' }).then(function (response) {
      if (response.ok) {
          response.json().then(function (resposta) {

            console.log('legal' + resposta)
              plotarGraficoAlerta(resposta)

          });
      } else {
          console.error('Nenhum dado encontrado ou erro na API');
      }
  })
      .catch(function (error) {
          console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
      });


}

function plotarGraficoAlerta(resposta) {


  const ctx = document.getElementById('myChart');
  var viewDivExit = false;

  new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
      datasets: [{
        label: 'alertas vermelhos',
        borderColor: 'red',
        backgroundColor: 'red',
        data: [20, 10, 10, 23, 34, 12, 25, 12, 12, 52, 34, resposta[0].quantidade],
        borderWidth: 2,
      },
      {
        label: 'alertas amarelos',
        borderColor: 'yellow',
        backgroundColor: 'yellow',
        data: [34, 15, 32, 21, 3, 12, 21, 12, 2, 42, 21, resposta[1].quantidade],
        borderWidth: 2
      },

      ]

    },
    options: {
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });




}

</script>